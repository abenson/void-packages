# Template file for 'volatility3'
pkgname=volatility3
version=2.26.0
revision=1
build_style=python3-pep517
hostmakedepends="python3-poetry-core python3-setuptools"
depends="python3-pefile python3-yara capstone-python3 python3-pycryptodome
 python3-snappy"
checkdepends="python3-pytest $depends"
short_desc="Advanced memory analysis and extraction tool"
maintainer="Andrew Benson <abenson+void@gmail.com>"
license="custom:Volatility Source License-1.0"
homepage="https://volatilityfoundation.org/"
distfiles="https://github.com/volatilityfoundation/volatility3/archive/refs/tags/v${version}.tar.gz
 https://downloads.volatilityfoundation.org/volatility3/symbols/windows.zip
 https://downloads.volatilityfoundation.org/volatility3/symbols/mac.zip
 https://downloads.volatilityfoundation.org/volatility3/symbols/linux.zip
 https://downloads.volatilityfoundation.org/volatility3/images/win-xp-laptop-2005-06-25.img.gz"
checksum="98edc1cb58cbecd9ea34f00b7f44764cfda27379ed7b4197443138e7bd0c4e26
 231d69735b9a5482b16bdbf1ec356e0a95574c44079e68dfb02ebddb34d55f3e
 fd12c8338724b175b0c5765af3313328b700ad53de4a00b4aa50e9a8bcef9129
 d9d03616858c8247d62921656c1238e54daa7aa024c1b496ec624fd90c6231e2
 4cbdd5725adbb9505c8b3f4a51f0f042bac8dd53bf1dcc4b3bb7c71a6c8a74cd"
skip_extraction="windows.zip mac.zip linux.zip win-xp-laptop-2005-06-25.img.gz"
nonfree=yes

do_check() {
	zcat "${XBPS_SRCDISTDIR}/${pkgname}-${version}/win-xp-laptop-2005-06-25.img.gz" > win-xp.img
	py.test ./test/test_volatility.py                                 \
	 --volatility="vol.py --image win-xp.img"   \
	 -k test_windows
}

post_install() {
	# Install symbol data
	for symbols in windows.zip mac.zip linux.zip; do
		bsdtar xf "${XBPS_SRCDISTDIR}/${pkgname}-${version}/$symbols" \
		 -C "${DESTDIR}/${py3_sitelib}/volatility3/symbols"
	done
	# Remove random crap it installs anyway
	for dir in build doc test; do
		rm -rf "${DESTDIR}/${py3_sitelib}/$dir"
	done
}
